<!DOCTYPE HTML>

<html>
    <head>
        <title>
            RPC на основе WAI
        </title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content>
        <meta name="author" content>
        <link rel="icon" type="image/png" href="../../../../../static/images/favicon.ico">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js">
            
        </script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css">
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/js/bootstrap.min.js">
            
        </script>
        <script type="text/x-mathjax-config">
                    MathJax.Hub.Config({
            extensions: ["tex2jax.js"],
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                processEscapes: true,
            },
            "HTML-CSS": { availableFonts: ["TeX"] },
            TeX: {
                extensions: ["AMScd.js", "enclose.js"],
            },
        });
        
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
            
        </script>
        <style>
            
@import url(https://fonts.googleapis.com/css?family=Roboto+Condensed:400,400i,700|Roboto+Mono:400,400i,700&subset=cyrillic);
body
{
  font-family      : "Roboto Condensed", sans-serif;
  font-size        : 18px;
  background-color : #f6f6f6;
  background-image : url("/static/images/satinweave.png");
}

a:hover
{
  color : black !important;
}

a:link
{
  color : black !important;
}

a:visited
{
  color : black !important;
}

a:active
{
  color : black !important;
}

.footer
{
  margin         : 0px auto 0px auto;
  max-width      : 86%;
  padding-top    : 70px;
  padding-bottom : 50px;
  color          : #777777;
  font-size      : 94%;
}

.left
{
  text-align : left;
}

.right
{
  text-align : right;
}

.center
{
  text-align : center;
}

h1
{
  text-align     : center;
  font-size      : 200%;
  padding-top    : 30px;
  padding-bottom : 30px;
}

h2
{
  font-size      : 160%;
  padding-top    : 30px;
  padding-bottom : 25px;
}

h3
{
  font-size      : 140%;
  padding-top    : 25px;
  padding-bottom : 20px;
}

a
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:hover
{
  color           : #5493ff;
  text-decoration : none;
  border-bottom   : solid 1px #999999;
}

a:visited
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

a:active
{
  color           : #2d3644;
  text-decoration : none;
  border-bottom   : dotted 1px #333333;
}

.href-to-original
{
  text-align  : right;
  font-size   : 90%;
  padding-top : 10px;
}

#authors-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#about-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#tags-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#categories-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#links-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-1
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-2
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-3
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-4
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#sl-5
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#go-home
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#hakyll-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

#mit-link
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

.fpconf-link
{
  font-size : 120%;
}

.fby-link
{
  font-size : 120%;
}

.friends-separator
{
  padding-left : 30px;
}

.navigation
{
  max-width      : 86%;
  margin         : 0px auto 0px auto;
  padding-top    : 40px;
  padding-bottom : 40px;
  font-size      : 120%;
}

.links
{
  margin-top     : 17px;
  font-size      : 90%;
  padding-bottom : 10px;
}

.logo-area
{
  text-align : center;
}

.social-links
{
  text-align : right;
  margin-top : 10px;
  font-size  : 140%;
}

.social-links-separator
{
  padding-right : 20px;
}

.links-separator
{
  padding-right : 20px;
}

.reddit-color
{
  color : #ff4500;
}

.twitter-color
{
  color : #1da1f2;
}

.gitter-color
{
  color : #e10454;
}

.github-color
{
  color : #000000;
}

.rss-color
{
  color : #ff924a;
}

.name-of-category
{
  font-size        : 85%;
  border           : solid 1px #ffbcb1;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fec1b7;
  padding-top      : 3px;
  padding-bottom   : 3px;
  padding-left     : 5px;
  padding-right    : 5px;
  margin-right     : 22px;
}

.post-info
{
  color          : #777777;
  font-size      : 90%;
  font-family    : "Roboto Mono", monospace;
  text-align     : left;
  padding-top    : 10px;
  padding-bottom : 60px;
}

.post-list
{
  padding         : 0px 0px 0px 0px;
  margin          : 0px 0px 0px 0px;
  list-style-type : none;
  font-size       : 110%;
}


.post-list li
{
  margin-top     : 21px;
  padding-bottom : 21px;
}


.post-list a
{
  text-decoration : none;
}


.post-list a:hover
{
  text-decoration : none;
}

.post-comments
{
  padding-left  : 15px;
  padding-right : 5px;
  font-size     : 90%;
  color         : #777777;
}

.comments-link
{
  font-size : 90%;
  color     : #777777;
}

.post-date
{
  text-align : right;
  color      : #888888;
}

.archive-button
{
  padding-top : 26px;
}

.undecorated
{
  text-decoration : none;
  border-bottom   : solid 0px #ffffff;
}

img[src*='#center']
{
  margin    : 0px auto 0px auto;
  display   : block;
  max-width : 100%;
}

.social-buttons-separator
{
  padding-top : 40px;
}

.heart-color
{
  color : #ff3a1d;
}

.tags-cloud
{
  text-align     : center;
  padding-top    : 30px;
  padding-bottom : 30px;
  margin         : 0px auto 0px auto;
  max-width      : 60%;
}

.tag-default
{
  background-color : #fec1b7;
  border           : solid 1px #ffbcb1;
  color            : inherit;
}


.sourceCode code
{
  font-family : "Roboto Mono", monospace;
}

pre.sourceCode
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border           : solid 1px #fbe7d8;
  border-radius    : 3px 3px 3px 3px;
  background-color : #fdf6e3;
  color            : #073642;
  padding-top      : 10px;
  padding-bottom   : 10px;
  padding-left     : 15px;
  padding-right    : 15px;
  margin-top       : 20px;
  margin-bottom    : 20px;
}


#content p > code
{
  font-family      : "Roboto Mono", monospace;
  font-size        : 94%;
  border-radius    : 3px 3px 3px 3px;
  border           : solid 1px #fbe7d8;
  background-color : #fdf6e3;
  color            : #000000;
  padding-top      : 1px;
  padding-bottom   : 1px;
  padding-left     : 4px;
  padding-right    : 4px;
}


pre.sourceCode span.kw
{
  color       : #007020;
  font-weight : 600;
}


pre.sourceCode span.dt
{
  color : #902000;
}


pre.sourceCode span.dv
{
  color : #40a070;
}


pre.sourceCode span.bn
{
  color : #40a070;
}


pre.sourceCode span.fl
{
  color : #40a070;
}


pre.sourceCode span.ch
{
  color : #4070a0;
}


pre.sourceCode span.co
{
  color : #60a0b0;
}


pre.sourceCode span.ot
{
  color : #007020;
}


pre.sourceCode span.al
{
  color       : #fa0202;
  font-weight : 600;
}


pre.sourceCode span.fu
{
  color : #06287e;
}


pre.sourceCode span.er
{
  color       : #fa0202;
  font-weight : 600;
}

th, td
{
  border-color : #808080;
  border-style : solid;
  border-width : 1px;
}

:target
{
  background-color : #ffff00;
}


/* Generated with Clay, http://fvisser.nl/clay */
        </style>
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-58217738-1', 'auto');
ga('send', 'pageview');

        </script>
        <script>
            window.___gcfg = { lang: 'ru' };
        </script>
        <script src="https://apis.google.com/js/platform.js">
            
        </script>
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://ruhaskell.org/feed.xml">
    </head>
    <body>
        <div class="container-fluid">
            <div class="navigation">
                <div class="row">
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="links">
                            <a href="../../../../../authors.html" id="authors-link">
                                Авторы
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../tags.html" id="tags-link">
                                Темы
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../categories.html" id="categories-link">
                                Разделы
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../about.html" id="about-link">
                                О нас
                            </a>
                            <span class="links-separator">
                                
                            </span>
                            <a href="../../../../../links.html" id="links-link">
                                Ресурсы
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                        <div class="logo-area">
                            <a href="../../../../../" title="Домой" id="go-home">
                                <img src="../../../../../static/images/logo.svg" alt="ruHaskell" width="100">
                            </a>
                        </div>
                    </div>
                    <div class="col-lg-5 col-md-5 col-sm-12 col-xs-12">
                        <div class="social-links">
                            <a href="../../../../../links.html#discussion" id="sl-1" title="Общение">
                                <i class="fa fa-commenting gitter-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="https://twitter.com/ruHaskell" id="sl-2" title="Следите за нашим Твиттером">
                                <i class="fa fa-twitter twitter-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="https://www.reddit.com/r/ruhaskell/" id="sl-3" title="Наш реддит-канал">
                                <i class="fa fa-reddit-alien reddit-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="https://github.com/ruHaskell/ruhaskell" id="sl-4" title="Мы живём на GitHub">
                                <i class="fa fa-github github-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                            <span class="social-links-separator">
                                
                            </span>
                            <a href="../../../../../feed.xml" id="sl-5" title="Наш RSS">
                                <i class="fa fa-rss rss-color" aria-hidden="true">
                                    
                                </i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="content">
                <h1>
    RPC на основе WAI
</h1>
<div class="row">
    <div class="col-xs-9 col-sm-8 col-md-8 col-lg-8">
        <div class="post-info">
            <strong>let</strong> author&nbsp;&nbsp;&nbsp;= "<a href="../../../../../authors/%D0%90%D0%BB%D0%B5%D0%BA%D1%81%D0%B5%D0%B9%20%D0%9F%D0%B8%D1%80%D0%BE%D0%B3%D0%BE%D0%B2.html">Алексей Пирогов</a>"<br />
&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= fromGregorian 2015 sep 01<br />
&nbsp;&nbsp;&nbsp;&nbsp;category = "<a href="../../../../../categories/web.html">Веб</a>"<br />
&nbsp;&nbsp;&nbsp;&nbsp;tags&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= [&quot;<a href="../../../../../tags/WAI.html">WAI</a>&quot;]

        </div>
    </div>
    <div class="col-xs-3 col-sm-4 col-md-4 col-lg-4">
        
    <div class="href-to-original">
        <a href="https://astynax.github.io/posts/2015-09-01-wai-rpc.html" target="_blank">Оригинал <span class="fa fa-external-link"></span></a>
    </div>


    </div>
</div>


<div>
    <h1 id="введение">Введение</h1>
<p>Сейчас web-разработка на <strong>Haskell</strong> достаточно проста, даже для новичка. Этому способствует наличие таких пакетов, как <a href="http://www.yesodweb.com/">Yesod</a> и <a href="http://snapframework.com/">Snap</a>. Но не всегда их мощь и полнота охвата необходимы. Порой от “сервера” требуется столь мало, что не хочется иметь в зависимостях подобных “монстров”, особенно в тех случаях, когда задача <em>достаточно легко</em> решаема и более простыми средствами.</p>
<p>Пусть примером послужит такая задача: требуется реализовать сервис, позволяющий вызывать на сервере некие функции и получать результат вызова, или, говоря общепринятым языком, выполнять <a href="https://en.wikipedia.org/wiki/Remote_procedure_call">RPC</a>.</p>
<p>Такую задачу можно решить, используя <a href="http://hackage.haskell.org/package/Spock">Spock</a>, <a href="http://hackage.haskell.org/package/scotty">scotty</a> или, скажем, <a href="http://hackage.haskell.org/package/servant">servant</a>, но “мы пойдем другим путем”<a href="https://ru.wikipedia.org/wiki/%D0%9B%D0%B5%D0%BD%D0%B8%D0%BD%D1%81%D0%BA%D0%B8%D0%B5_%D1%84%D1%80%D0%B0%D0%B7%D1%8B">©</a>!</p>
<p>Большинство библиотек для web-разработки внутри использует так называемый <strong>Web Application Interface</strong> (<a href="http://hackage.haskell.org/package/wai">WAI)</a> - обобщенный <em>протокол общения web-сервера и web-приложения</em>. Приложения, реализующие этот протокол, называют WAI-приложениями и запускают с помощью сервера wai-приложений - <a href="http://www.stackage.org/package/warp">warp</a>.</p>
<p>Реализуем же и мы простой сервис на чистом WAI!</p>
<h1 id="wai-сервис">WAI-сервис</h1>
<h2 id="задача">Задача</h2>
<p>Реализовать сервис вызова функций типа <code>String -&gt; String</code>. Для примера реализуем функции <code>reverse</code>, <code>upper</code> и <code>lower</code>.</p>
<p>API будет следующим:</p>
<ul>
<li><code>GET</code> на <code>/</code> возвращает список имен доступных функций (по одному на строку),</li>
<li><code>GET</code> на <code>/&lt;function_name&gt;</code> возвращает описание функции,</li>
<li><code>GET</code> на <code>/&lt;function_name&gt;?&lt;argument&gt;</code> возвращает результат вызова функции.</li>
</ul>
<h2 id="hello-world">“Hello, World!”</h2>
<p>Для начала создадим проект и реализуем сервер-заглушку, отвечающий известной строкой на любой запрос. <strong>Обратите внимание:</strong> исходники проекта <a href="https://github.com/astynax/wai-rpc">доступны на github</a>.</p>
<p>Создаем проект:</p>
<pre class="shell"><code>$ stack new wai-rpc simple --resolver lts-3.2
</code></pre>
<p><strong>ВНИМАНИЕ:</strong> предполагается, что у вас установлена утилита <a href="https://github.com/commercialhaskell/stack">stack</a>, а ключ <code>--resolver lts-3.2</code> означает, что будет использоваться снимок версии 3.2 - именно этот снимок был актуален на момент написания статьи. (подробнее о снимках можно почитать в документации к stack).</p>
<p>После создания проекта добавляем зависимости <code>http-types</code>, <code>wai</code> и <code>warp</code> в <code>.cabal</code>-файл:</p>
<pre class="shell"><code>-- ...часть файла опущена...
executable wai-rpc
  hs-source-dirs:      src
  main-is:             Main.hs
  default-language:    Haskell2010
  build-depends:       base &gt;= 4.7 &amp;&amp; &lt; 5,
                       http-types, wai, warp -- &lt;-- добавлено
</code></pre>
<p>Затем содержимое файла <code>src/Main.hs</code> заменяем на:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> <span class="dt">Network.Wai</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (status200, hContentType)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">import</span> <span class="dt">Network.Wai.Handler.Warp</span> (run)</a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="ot">application ::</span> <span class="dt">Application</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">application _ respond <span class="fu">=</span> respond <span class="fu">$</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">  responseLBS status200</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">              [(hContentType, <span class="st">&quot;text/plain&quot;</span>)]</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">              <span class="st">&quot;Hello World&quot;</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="ot">main ::</span> <span class="dt">IO</span> ()</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  putStrLn <span class="st">&quot;Serving...&quot;</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17">  run <span class="dv">8000</span> application</a></code></pre></div>
<p>К слову, этот код практически слово-в-слово повторяет <a href="http://www.yesodweb.com/book/web-application-interface#web-application-interface_hello_world">helloworld</a> от авторов библиотеки WAI ;)</p>
<p>Осталось собрать проект:</p>
<pre class="shell"><code>$ stack build
</code></pre>
<p>И запустить:</p>
<pre class="shell"><code>$ stack exec wai-rpc
Serving (hit Ctrl+C to stop)...
</code></pre>
<p>Если при запущенном сервере открыть в браузере url <a href="http://localhost:8000" class="uri">http://localhost:8000</a>, то в окне отобразится ожидаемое приветствие. Сервер работает!</p>
<p>Теперь стоит разобрать, из чего же состоит наш сервер.</p>
<p><code>main</code> содержит строку</p>
<pre class="shell"><code>run 8000 application
</code></pre>
<p>Это запуск сервера <code>warp</code> на порту <code>8000</code> с единственным WAI-приложением - <code>application</code>.</p>
<p>Приложение <code>application</code> имеет тип <a href="http://haddock.stackage.org/lts-3.2/wai-3.0.3.0/Network-Wai.html#t:Application">Application</a>, который является синонимом для</p>
<pre class="shell"><code>type Application = Request
                   -&gt; (Response -&gt; IO ResponseReceived)
                   -&gt; IO ResponseReceived
</code></pre>
<p>Здесь первый аргумент, это тип <a href="http://haddock.stackage.org/lts-3.2/wai-3.0.3.0/Network-Wai.html#t:Request">Request</a>, описывающий запрос, а второй, это “ответчик” - функция, призванная возвращать ответ <a href="http://haddock.stackage.org/lts-3.2/wai-3.0.3.0/Network-Wai.html#t:Response">Response</a> в процессе выполнения некой работы (для этого в типе монада <code>IO</code>).</p>
<p>В данном случае приложение сразу же отвечает фиксированным сообщением, поэтому тело приложения - единственный вызов ответчика <code>respond</code>.</p>
<p>Ответ же в данном случае выглядит так:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1">responseLBS status200</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">            <span class="co">-- :: Network.HTTP.Types.Status</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">            [(hContentType, <span class="st">&quot;text/plain&quot;</span>)]</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">            <span class="co">-- :: [(Network.HTTP.Types.HeaderName</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">            <span class="co">--     ,ByteString)]</span></a>
<a class="sourceLine" id="cb8-6" data-line-number="6">            <span class="st">&quot;Hello World!&quot;</span></a>
<a class="sourceLine" id="cb8-7" data-line-number="7">            <span class="co">-- :: Lazy ByteString</span></a></code></pre></div>
<p>Всё достаточно привычно: статус, заголовки и тело.</p>
<p>Вот, собственно и всё! Это уже вполне самостоятельный сервер, можно пускать в production :) И это не шутка - warp испытан и проверен, и, ко всему прочему, <a href="http://www.techempower.com/benchmarks/#section=data-r10&amp;hw=ec2&amp;test=json&amp;c=5&amp;f=28ougw-9zle8-0-0">весьма быстр</a> и <a href="http://www.aosabook.org/en/posa/warp.html">пригоден</a> для “вывешивания наружу” (т.е. не требует заворачивания во всякие Nginx).</p>
<h2 id="маршрутизация">Маршрутизация</h2>
<p>Сервер работает, настало время решать конкретную задачу. Для начала заведем несколько вспомогательных функций для работы с ответами:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Network.Wai</span> (<span class="dt">Response</span>)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (<span class="dt">Status</span>, notFound404,</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                           badRequest400)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Lazy</span> <span class="kw">as</span> <span class="dt">LBS</span></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"></a>
<a class="sourceLine" id="cb9-6" data-line-number="6"><span class="co">-- ...</span></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">responseOk, responseNotFound, responseBadRequest</a>
<a class="sourceLine" id="cb9-9" data-line-number="9"><span class="ot">  ::</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Response</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">responseOk         <span class="fu">=</span> responsePlainText status200</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">responseNotFound   <span class="fu">=</span> responsePlainText notFound404</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">responseBadRequest <span class="fu">=</span> responsePlainText badRequest400</a>
<a class="sourceLine" id="cb9-13" data-line-number="13"></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="ot">responsePlainText ::</span> <span class="dt">Status</span> <span class="ot">-&gt;</span> <span class="dt">LBS.ByteString</span> <span class="ot">-&gt;</span> <span class="dt">Response</span></a>
<a class="sourceLine" id="cb9-15" data-line-number="15">responsePlainText <span class="fu">=</span></a>
<a class="sourceLine" id="cb9-16" data-line-number="16">  (<span class="ot">`responseLBS`</span> [(hContentType, <span class="st">&quot;text/plain&quot;</span>)])</a></code></pre></div>
<p>(в зависимости проекта нужно будет добавить <code>bytestring</code>)</p>
<p>Так как мы собираемся обрабатывать только <code>GET</code>-запросы, добавим отсечку по типу запроса с соответствующим сообщением об ошибке:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Network.Wai</span> (requestMethod)</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (methodGet)</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">application req respond <span class="fu">=</span> respond <span class="fu">$</span></a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="kw">if</span> requestMethod req <span class="fu">/=</span> methodGet</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">  <span class="kw">then</span> responseBadRequest <span class="st">&quot;Only GET method is allowed!&quot;</span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7">  <span class="kw">else</span> <span class="co">-- далее всё как раньше с учетом вспом. функций</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">    responseOk <span class="st">&quot;Hello World&quot;</span></a></code></pre></div>
<p><code>GET</code>-запросы мы уже фильтруем, теперь на запрос к корневому url нужно возвращать список функций. Значит нужна библиотека функций:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.Map.Strict</span> (<span class="dt">Map</span>, fromList, lookup, keys)</a>
<a class="sourceLine" id="cb11-2" data-line-number="2"><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.ByteString.Char8</span> <span class="kw">as</span> <span class="dt">BS</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">import</span> <span class="dt">Prelude</span> <span class="kw">hiding</span> (lookup)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="co">-- ...</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6"></a>
<a class="sourceLine" id="cb11-7" data-line-number="7"><span class="kw">type</span> <span class="dt">FunctionName</span>        <span class="fu">=</span> <span class="dt">BS.ByteString</span></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">type</span> <span class="dt">FunctionDescription</span> <span class="fu">=</span> <span class="dt">BS.ByteString</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">type</span> <span class="dt">FunctionArg</span>         <span class="fu">=</span> <span class="dt">BS.ByteString</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"><span class="kw">type</span> <span class="dt">FunctionResult</span>      <span class="fu">=</span> <span class="dt">BS.ByteString</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="kw">type</span> <span class="dt">FunctionSpec</span>        <span class="fu">=</span> (<span class="dt">FunctionDescription</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                           ,(<span class="dt">FunctionArg</span> <span class="ot">-&gt;</span> <span class="dt">FunctionResult</span>))</a>
<a class="sourceLine" id="cb11-13" data-line-number="13"></a>
<a class="sourceLine" id="cb11-14" data-line-number="14"><span class="ot">library ::</span> <span class="dt">Map</span> <span class="dt">FunctionName</span> <span class="dt">FunctionSpec</span></a>
<a class="sourceLine" id="cb11-15" data-line-number="15">library <span class="fu">=</span> fromList []</a>
<a class="sourceLine" id="cb11-16" data-line-number="16"></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="ot">getFunctionSpec ::</span> <span class="dt">FunctionName</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">FunctionSpec</span></a>
<a class="sourceLine" id="cb11-18" data-line-number="18">getFunctionSpec <span class="fu">=</span> (<span class="ot">`lookup`</span> library)</a>
<a class="sourceLine" id="cb11-19" data-line-number="19"></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="ot">listOfFunctions ::</span> [<span class="dt">FunctionName</span>]</a>
<a class="sourceLine" id="cb11-21" data-line-number="21">listOfFunctions <span class="fu">=</span> keys library</a>
<a class="sourceLine" id="cb11-22" data-line-number="22"></a>
<a class="sourceLine" id="cb11-23" data-line-number="23"><span class="ot">describe ::</span> <span class="dt">FunctionSpec</span> <span class="ot">-&gt;</span> <span class="dt">FunctionDescription</span></a>
<a class="sourceLine" id="cb11-24" data-line-number="24">describe <span class="fu">=</span> fst</a>
<a class="sourceLine" id="cb11-25" data-line-number="25"></a>
<a class="sourceLine" id="cb11-26" data-line-number="26"><span class="ot">call ::</span> <span class="dt">FunctionSpec</span> <span class="ot">-&gt;</span> <span class="dt">FunctionArg</span> <span class="ot">-&gt;</span> <span class="dt">FunctionResult</span></a>
<a class="sourceLine" id="cb11-27" data-line-number="27">call <span class="fu">=</span> snd</a></code></pre></div>
<p>(в зависимости проекта нужно будет добавить <code>containers</code>)</p>
<p>Самих функций пока нет, но библиотека есть, как есть и функции для работы с ней. Можно уже выводить список функций, но перед этим нужно понять, что запрос производится на “корневой” url и не содержит параметров. Добавим ветвления в наше приложение, заодно переписав <code>if</code>-ветки в виде охранных выражений:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Network.Wai</span> (rawPathInfo, rawQueryString)</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="co">-- ...</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5">application req respond</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">  <span class="fu">|</span> requestMethod req <span class="fu">/=</span> methodGet <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    respond</a>
<a class="sourceLine" id="cb12-8" data-line-number="8">    <span class="fu">$</span> responseBadRequest <span class="st">&quot;Only GET method is allowed!&quot;</span></a>
<a class="sourceLine" id="cb12-9" data-line-number="9"></a>
<a class="sourceLine" id="cb12-10" data-line-number="10">  <span class="fu">|</span> path <span class="fu">==</span> <span class="st">&quot;&quot;</span> <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-11" data-line-number="11">    respond</a>
<a class="sourceLine" id="cb12-12" data-line-number="12">    <span class="fu">$</span> <span class="kw">if</span> query <span class="fu">/=</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13">      <span class="kw">then</span> responseBadRequest <span class="st">&quot;No query parameters needed!&quot;</span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14">      <span class="kw">else</span> responseOk renderedListOfFunctions</a>
<a class="sourceLine" id="cb12-15" data-line-number="15"></a>
<a class="sourceLine" id="cb12-16" data-line-number="16">  <span class="fu">|</span> otherwise <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-17" data-line-number="17">    respond</a>
<a class="sourceLine" id="cb12-18" data-line-number="18">    <span class="fu">$</span> responseOk <span class="st">&quot;Hello World&quot;</span></a>
<a class="sourceLine" id="cb12-19" data-line-number="19"></a>
<a class="sourceLine" id="cb12-20" data-line-number="20">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21">    query <span class="fu">=</span> rawQueryString req</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">    path  <span class="fu">=</span> BS.tail <span class="fu">$</span> rawPathInfo req <span class="co">-- без ведущего '/'</span></a>
<a class="sourceLine" id="cb12-23" data-line-number="23"></a>
<a class="sourceLine" id="cb12-24" data-line-number="24">    renderedListOfFunctions <span class="fu">=</span></a>
<a class="sourceLine" id="cb12-25" data-line-number="25">      LBS.intercalate <span class="st">&quot;\n&quot;</span></a>
<a class="sourceLine" id="cb12-26" data-line-number="26">      <span class="fu">$</span> <span class="st">&quot;Available functions:&quot;</span></a>
<a class="sourceLine" id="cb12-27" data-line-number="27">        <span class="fu">:</span> map LBS.fromStrict listOfFunctions</a></code></pre></div>
<p>Теперь у нашего сервера есть <strong>маршрутизация</strong>, пусть и в зачаточном виде :)</p>
<p>Проверим работу того, что уже наработано, с помощью <code>curl</code> (предполагается, что сервер запущен в другом окне терминала):</p>
<pre class="shell"><code>$ curl http://localhost:8000
Available functions:
</code></pre>
<pre class="shell"><code>$ curl http://localhost:8000?asdf
No query parameters needed!
</code></pre>
<h2 id="получение-описание-и-вызов-функций">Получение описание и вызов функций</h2>
<p>Теперь корневой url обрабатывается. Настало время поиска функции в библиотеке:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb15-1" data-line-number="1">application req respond</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">  <span class="co">-- тут существующая маршрутизация</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="fu">|</span> otherwise <span class="fu">=</span></a>
<a class="sourceLine" id="cb15-4" data-line-number="4">    respond</a>
<a class="sourceLine" id="cb15-5" data-line-number="5">    <span class="fu">$</span> maybe</a>
<a class="sourceLine" id="cb15-6" data-line-number="6">    (responseNotFound <span class="st">&quot;Unknown function!&quot;</span>)</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">    (\spec <span class="ot">-&gt;</span> responseOk</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">              <span class="fu">$</span> LBS.fromStrict</a>
<a class="sourceLine" id="cb15-9" data-line-number="9">              <span class="fu">$</span> <span class="kw">if</span> query <span class="fu">==</span> <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb15-10" data-line-number="10">                <span class="kw">then</span> describe spec</a>
<a class="sourceLine" id="cb15-11" data-line-number="11">                <span class="kw">else</span> call spec query)</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">    <span class="fu">$</span> getFunctionSpec path</a></code></pre></div>
<p>Функций пока нет, но поиск уже работает. Проверим:</p>
<pre class="shell"><code>$ curl http://localhost:8000/func
Unknown function!
</code></pre>
<p>Добавим же наконец пару функций в библиотеку:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Data.Char</span> (toUpper)</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co">-- ...</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="ot">library ::</span> <span class="dt">Map</span> <span class="dt">FunctionName</span> <span class="dt">FunctionSpec</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6">library <span class="fu">=</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7">  fromList [(<span class="st">&quot;reverse&quot;</span>, (<span class="st">&quot;returns string with characters in reverset order&quot;</span>,</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">                         BS.reverse ))</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">           ,(<span class="st">&quot;upper&quot;</span>,   (<span class="st">&quot;returns string with each character in upper case&quot;</span>,</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">                         BS.map toUpper ))]</a></code></pre></div>
<p>И, разумеется, проверим:</p>
<pre class="shell"><code>$ curl http://localhost:8000
Available functions:
reverse
upper
</code></pre>
<pre class="shell"><code>$ curl http://localhost:8000/reverse
returns string with characters in reverset order
</code></pre>
<pre class="shell"><code>$ curl http://localhost:8000/reverse?Hello+World
dlroW olleH
</code></pre>
<p>Готово! Есть функции, и их можно вызывать удалённо!</p>
<h2 id="финальные-штрихи">Финальные штрихи</h2>
<p>Сервер у нас есть, но неплохо было бы видеть какие запросы он получает и что на них отвечает, т.е. нам нужно логирование. Существует готовый пакет <a href="http://haddock.stackage.org/lts-3.2/wai-logger-2.2.4.1/Network-Wai-Logger.html">wai-logger</a>, однако для практики мы напишем свою реализацию логирования - тоже простейшую.</p>
<p>Когда при работе с WAI-приложениями возникает необходимость сделать что-то с запросами и/или ответами на них, на сцену выходит тип <a href="http://haddock.stackage.org/lts-3.2/wai-3.0.3.0/Network-Wai.html#t:Middleware">Middleware</a>:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="dt">Middleware</span><span class="ot"> ::</span> <span class="dt">Application</span> <span class="ot">-&gt;</span> <span class="dt">Application</span></a></code></pre></div>
<p>Middleware - это преобразователь приложений, настоящая <em>функция высшего порядка</em>! Как же такие преобразователи пишутся? Довольно просто:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Network.Wai</span> (<span class="dt">Middleware</span>, responseStatus)</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Network.HTTP.Types</span> (statusCode)</a>
<a class="sourceLine" id="cb22-3" data-line-number="3"></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">-- ...</span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="ot">withLogging ::</span> <span class="dt">Middleware</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7">withLogging app req respond <span class="fu">=</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8">  app req <span class="fu">$</span> \response <span class="ot">-&gt;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9">    putStrLn <span class="fu">$</span> statusOf response <span class="fu">++</span> <span class="st">&quot;: &quot;</span> <span class="fu">++</span> query</a>
<a class="sourceLine" id="cb22-10" data-line-number="10">    respond response</a>
<a class="sourceLine" id="cb22-11" data-line-number="11">  <span class="kw">where</span></a>
<a class="sourceLine" id="cb22-12" data-line-number="12">    query <span class="fu">=</span> BS.unpack</a>
<a class="sourceLine" id="cb22-13" data-line-number="13">          <span class="fu">$</span> BS.concat [ rawPathInfo    req</a>
<a class="sourceLine" id="cb22-14" data-line-number="14">                      , rawQueryString req ]</a>
<a class="sourceLine" id="cb22-15" data-line-number="15">    statusOf <span class="fu">=</span> show <span class="fu">.</span> statusCode <span class="fu">.</span> responseStatus</a>
<a class="sourceLine" id="cb22-16" data-line-number="16"></a>
<a class="sourceLine" id="cb22-17" data-line-number="17"> main <span class="fu">=</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb22-18" data-line-number="18">   putStrLn <span class="fu">...</span></a>
<a class="sourceLine" id="cb22-19" data-line-number="19">   run <span class="dv">8000</span> <span class="fu">$</span> withLogging application</a></code></pre></div>
<p>Ничего сверх-естественного, оборачивание вызова функции, как оно есть.</p>
<p>Выглядит вывод logger’а примерно так:</p>
<pre class="shell"><code>$ stack exec wai-rpc
Serving (hit Ctrl+C to stop)...
200: /reverse?Hello%20World
200: /
404: /asdf
400: /?asdf
...
</code></pre>
<p>Подобным образом можно осуществлять маршрутизацию, проверку на наличие, или отсутствие cookies, оптимизацию(сжатие) ответов и кэширование запросов. Такой подход, на мой взгляд, очень композируем да и просто и элегантен!</p>
<h1 id="заключение">Заключение</h1>
<p>Даже такой простой пример позволяет понять, что разработка сервисов на “голом” WAI не только довольно проста, но и вполне удобна и приятна :)</p>
</div>
<div class="social-buttons-separator">
    
</div>
<div id="socialButtons">
    <a href="https://twitter.com/share" class="twitter-share-button" data-lang="ru" data-size="large">Твитнуть</a> <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>

</div>
<div class="social-buttons-separator">
    
</div>
<div>
    <div id="disqus_thread"></div>    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ruhaskell'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    
</div>

            </div>
        </div>
        <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 left">
                        © 2014-2018 ruHaskell
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 center">
                        <a href="http://jaspervdj.be/hakyll/" id="hakyll-link">
                            <span>
                                Мы
                            </span>
                            <i class="fa fa-heart heart-color" aria-hidden="true">
                                
                            </i>
                            <span>
                                Hakyll
                            </span>
                        </a>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-4 col-xs-4 right">
                        <a href="https://github.com/ruHaskell/ruhaskell/blob/master/LICENSE" id="mit-link">
                            <i class="fa fa-balance-scale" aria-hidden="true">
                                
                            </i>
                            <span>
                                MIT
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </footer>
    </body>
</html>
